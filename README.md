# Coding

(root de la shared lib)
└─ resources/
   └─ was/
         ├─ rep_config.py           # Jython: crea/asegura REP y sus custom properties
               └─ README.md               # (opcional) notas de uso


# resources/was/rep_config.py
# Uso esperado:
#   wsadmin -lang jython -f rep_config.py <propsFile> <cell> <node> <repName>
#
# Donde:
#   <propsFile> = ruta a archivo con "clave=valor" por línea (lineas vacías y #... se ignoran)
#   <cell>      = nombre de la Cell (ej: mycell)
#   <node>      = nombre del Node (scope donde vivirá el REP)
#   <repName>   = nombre del ResourceEnvironmentProvider a crear/asegurar

import sys

def wsadminToList(inlist):
    if inlist is None:
            return []
                s = str(inlist).strip()
                    if s.startswith('[') and s.endswith(']'):
                            s = s[1:-1]
                                if len(s) == 0:
                                        return []
                                            return [x for x in s.split() if x]

                                            def ensure_rep(cell, node, repName):
                                                nodeId = AdminConfig.getid('/Cell:%s/Node:%s/' % (cell, node))
                                                    if not nodeId:
                                                            print('[ERROR] Node no encontrado: %s/%s' % (cell, node))
                                                                    sys.exit(1)
                                                                        repId = AdminConfig.getid('/Cell:%s/Node:%s/ResourceEnvironmentProvider:%s/' % (cell, node, repName))
                                                                            if repId:
                                                                                    print('[INFO] REP ya existe: %s' % repId)
                                                                                            return repId
                                                                                                attrs = [['name', repName]]
                                                                                                    repId = AdminConfig.create('ResourceEnvironmentProvider', nodeId, attrs)
                                                                                                        print('[INFO] REP creado: %s' % repId)
                                                                                                            return repId

                                                                                                            def ensure_prop_set(repId):
                                                                                                                propSet = AdminConfig.showAttribute(repId, 'propertySet')
                                                                                                                    if not propSet:
                                                                                                                            propSet = AdminConfig.create('J2EEResourcePropertySet', repId, [])
                                                                                                                                    print('[INFO] PropertySet creado: %s' % propSet)
                                                                                                                                        else:
                                                                                                                                                print('[INFO] PropertySet existente: %s' % propSet)
                                                                                                                                                    return propSet

                                                                                                                                                    def find_prop(propSet, name):
                                                                                                                                                        items = wsadminToList(AdminConfig.showAttribute(propSet, 'resourceProperties'))
                                                                                                                                                            for pid in items:
                                                                                                                                                                    if name == AdminConfig.showAttribute(pid, 'name'):
                                                                                                                                                                                return pid
                                                                                                                                                                                    return None

                                                                                                                                                                                    def ensure_property(propSet, name, value=None, description=None, required=None):
                                                                                                                                                                                        pid = find_prop(propSet, name)
                                                                                                                                                                                            if pid:
                                                                                                                                                                                                    mods = []
                                                                                                                                                                                                            if value is not None:       mods.append(['value', value])
                                                                                                                                                                                                                    if description is not None: mods.append(['description', description])
                                                                                                                                                                                                                            if required is not None:    mods.append(['required', required])  # 'true'|'false'
                                                                                                                                                                                                                                    if mods:
                                                                                                                                                                                                                                                AdminConfig.modify(pid, mods)
                                                                                                                                                                                                                                                            print('[INFO] Propiedad actualizada: %s' % name)
                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                print('[INFO] Propiedad ya existía sin cambios: %s' % name)
                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                            attrs = [['name', name]]
                                                                                                                                                                                                                                                                                                    if value is not None:       attrs.append(['value', value])
                                                                                                                                                                                                                                                                                                            if description is not None: attrs.append(['description', description])
                                                                                                                                                                                                                                                                                                                    if required is not None:    attrs.append(['required', required])
                                                                                                                                                                                                                                                                                                                            pid = AdminConfig.create('J2EEResourceProperty', propSet, attrs)
                                                                                                                                                                                                                                                                                                                                    print('[INFO] Propiedad creada: %s (%s)' % (name, pid))
                                                                                                                                                                                                                                                                                                                                        return pid

                                                                                                                                                                                                                                                                                                                                        def list_properties(propSet, title):
                                                                                                                                                                                                                                                                                                                                            print('=== %s ===' % title)
                                                                                                                                                                                                                                                                                                                                                items = wsadminToList(AdminConfig.showAttribute(propSet, 'resourceProperties'))
                                                                                                                                                                                                                                                                                                                                                    for pid in items:
                                                                                                                                                                                                                                                                                                                                                            n = AdminConfig.showAttribute(pid, 'name')
                                                                                                                                                                                                                                                                                                                                                                    v = AdminConfig.showAttribute(pid, 'value')
                                                                                                                                                                                                                                                                                                                                                                            d = AdminConfig.showAttribute(pid, 'description')
                                                                                                                                                                                                                                                                                                                                                                                    r = AdminConfig.showAttribute(pid, 'required')
                                                                                                                                                                                                                                                                                                                                                                                            print(' - name=%s | value=%s | description=%s | required=%s' % (n, v, d, r))

                                                                                                                                                                                                                                                                                                                                                                                            def sync_node(node):
                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                        obj = AdminControl.completeObjectName('type=NodeSync,process=nodeagent,node=%s,*' % node)
                                                                                                                                                                                                                                                                                                                                                                                                                if obj:
                                                                                                                                                                                                                                                                                                                                                                                                                            print('[INFO] Sincronizando node %s ...' % node)
                                                                                                                                                                                                                                                                                                                                                                                                                                        print(AdminControl.invoke(obj, 'sync'))
                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                            print('[WARN] NodeSync MBean no encontrado (nodeagent no activo?): %s' % node)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                except:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print('[WARN] Error al sincronizar node: %s' % node)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def parse_props_file(path):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            props = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f = open(path, 'r')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for raw in f.readlines():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            line = raw.strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if len(line) == 0 or line.startswith('#'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if '=' not in line:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print('[WARN] Línea ignorada (sin "="): %s' % line)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        k, v = line.split('=', 1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                props.append( (k.strip(), v.strip()) )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    f.close()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return props

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # --- main ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(sys.argv) < 4:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print('Uso: wsadmin -f rep_config.py <propsFile> <cell> <node> <repName>')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sys.exit(2)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                propsFile = sys.argv[0]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cell      = sys.argv[1]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                node      = sys.argv[2]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                repName   = sys.argv[3]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print('[INFO] Cell=%s Node=%s REP=%s props=%s' % (cell, node, repName, propsFile))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                repId  = ensure_rep(cell, node, repName)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pSetId = ensure_prop_set(repId)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                list_properties(pSetId, 'PROPERTIES (ANTES)')

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for (k, v) in parse_props_file(propsFile):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ensure_property(pSetId, k, v, None, None)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    AdminConfig.save()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print('[INFO] Cambios guardados.')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sync_node(node)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    list_properties(pSetId, 'PROPERTIES (DESPUÉS)')


@Library('SSC_Automation') _   // <-- nombre de tu librería compartida en Jenkins

pipeline {
  agent { label "${params.NODE_LABEL}" }
  
    options {
        ansiColor('xterm')
            timestamps()
                buildDiscarder(logRotator(numToKeepStr: '30'))
                    disableConcurrentBuilds()
                      }
                      
                        parameters {
                            choice(name: 'NODE_LABEL', choices: ['master','linux','any'], description: 'Agente Jenkins')
                            
                                // DMGR / WAS
                                    string(name: 'SERVER',   defaultValue: 'was-admin-lam-co-assurance.staging.echonet', description: 'Host DMGR (SSH)')
                                        string(name: 'CELL',     defaultValue: 'mycell', description: 'Cell')
                                            string(name: 'NODE',     defaultValue: 'mynode', description: 'Node (scope del REP)')
                                                string(name: 'REP_NAME', defaultValue: 'REP1',   description: 'Nombre del ResourceEnvironmentProvider')
                                                
                                                    // Propiedades a aplicar (key=value por línea)
                                                        text(name: 'PROPERTIES', defaultValue: '''bootstrap.servers=host1:9092,host2:9092
                                                        schema.registry.url=https://reg1:8081
                                                        kafka.topic=COL_DigitalSales_PRD_PolicySold
                                                        ''', description: 'key=value por línea; líneas vacías o que comiencen con # se ignoran.')
                                                        
                                                            // Rutas / Credenciales
                                                                string(name: 'WSADMIN_PATH', defaultValue: '', description: 'Ruta wsadmin.sh (opcional). Si vacío, se detecta.')
                                                                    credentials(name: 'SSH_CREDS', defaultValue: 'was-ssh-key', description: 'SSH al DMGR (usuario SO + llave)')
                                                                        credentials(name: 'WAS_SOAP_CREDS', defaultValue: '', description: 'WAS user/pass (opcional si no usas soap.client.props)')
                                                                          }
                                                                          
                                                                            environment {
                                                                                LC_ALL = 'C.UTF-8'
                                                                                    LANG   = 'C.UTF-8'
                                                                                      }
                                                                                      
                                                                                        stages {
                                                                                            stage('Materializar archivos compartidos') {
                                                                                                  steps {
                                                                                                          sh 'rm -rf .wasrep && mkdir -p .wasrep'
                                                                                                                  // rep_config.py desde la shared lib (resources/was/rep_config.py)
                                                                                                                          script {
                                                                                                                                    def repScript = libraryResource('was/rep_config.py')
                                                                                                                                              writeFile file: '.wasrep/rep_config.py', text: repScript
                                                                                                                                                      }
                                                                                                                                                              // props.properties desde parámetro
                                                                                                                                                                      writeFile file: '.wasrep/props.properties', text: params.PROPERTIES
                                                                                                                                                                            }
                                                                                                                                                                                }
                                                                                                                                                                                
                                                                                                                                                                                    stage('Subir archivos al DMGR') {
                                                                                                                                                                                          steps {
                                                                                                                                                                                                  sshagent(credentials: [params.SSH_CREDS]) {
                                                                                                                                                                                                            sh """
                                                                                                                                                                                                                        set -euxo pipefail
                                                                                                                                                                                                                                    scp -o StrictHostKeyChecking=no .wasrep/rep_config.py ${params.SERVER}:/tmp/rep_config.py
                                                                                                                                                                                                                                                scp -o StrictHostKeyChecking=no .wasrep/props.properties ${params.SERVER}:/tmp/props.properties
                                                                                                                                                                                                                                                          """
                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                stage('Ejecutar wsadmin (crear REP, props, save, sync)') {
                                                                                                                                                                                                                                                                                      steps {
                                                                                                                                                                                                                                                                                              script {
                                                                                                                                                                                                                                                                                                        def soap = params.WAS_SOAP_CREDS?.trim()
                                                                                                                                                                                                                                                                                                                  if (soap) {
                                                                                                                                                                                                                                                                                                                              withCredentials([usernamePassword(credentialsId: params.WAS_SOAP_CREDS, usernameVariable: 'WAS_USER', passwordVariable: 'WAS_PASS')]) {
                                                                                                                                                                                                                                                                                                                                            sshagent(credentials: [params.SSH_CREDS]) {
                                                                                                                                                                                                                                                                                                                                                            sh """
                                                                                                                                                                                                                                                                                                                                                                              set -euxo pipefail
                                                                                                                                                                                                                                                                                                                                                                                                ssh -o StrictHostKeyChecking=no ${params.SERVER} bash -lc '
                                                                                                                                                                                                                                                                                                                                                                                                                    set -e
                                                                                                                                                                                                                                                                                                                                                                                                                                        WSADM="${params.WSADMIN_PATH}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                            [ -z "$WSADM" ] && WSADM="$(command -v wsadmin.sh || true)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if [ -z "$WSADM" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      WSADM="$(find /opt /IBM -type f -name wsadmin.sh 2>/dev/null | head -n1 || true)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "[INFO] wsadmin.sh: $WSADM"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "$WSADM" -lang jython -conntype SOAP -host ${params.SERVER} -port 9043 \\
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               -user "$WAS_USER" -password "$WAS_PASS" \\
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            -f /tmp/rep_config.py /tmp/props.properties ${params.CELL} ${params.NODE} ${params.REP_NAME} | tee /tmp/rep_config.out
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              '
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sshagent(credentials: [params.SSH_CREDS]) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sh """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            set -euxo pipefail
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ssh -o StrictHostKeyChecking=no ${params.SERVER} bash -lc '
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              set -e
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WSADM="${params.WSADMIN_PATH}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  [ -z "$WSADM" ] && WSADM="$(command -v wsadmin.sh || true)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if [ -z "$WSADM" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        WSADM="$(find /opt /IBM -type f -name wsadmin.sh 2>/dev/null | head -n1 || true)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "[INFO] wsadmin.sh: $WSADM"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "$WSADM" -lang jython -f /tmp/rep_config.py /tmp/props.properties ${params.CELL} ${params.NODE} ${params.REP_NAME} | tee /tmp/rep_config.out
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              '
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        stage('Traer logs y publicar artefactos') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              steps {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      sshagent(credentials: [params.SSH_CREDS]) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sh """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            set -euxo pipefail
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        scp -o StrictHostKeyChecking=no ${params.SERVER}:/tmp/rep_config.out .wasrep/ || true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  """
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  archiveArtifacts artifacts: '.wasrep/**', fingerprint: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo '[INFO] Artefactos: .wasrep/rep_config.py, .wasrep/props.properties, .wasrep/rep_config.out'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        post {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            success { echo '[SUCCESS] REP asegurado y propiedades aplicadas correctamente.' }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                failure { echo '[FAILURE] Revisa rep_config.out y la consola para diagnosticar.' }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }